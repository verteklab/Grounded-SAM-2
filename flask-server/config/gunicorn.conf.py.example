# Gunicorné…ç½®ç¤ºä¾‹ - æ ¹æ®GPUæ˜¾å­˜è°ƒæ•´workersæ•°é‡

# ============================================
# æ˜¾å­˜ä¸Workeræ•°é‡å¯¹åº”å…³ç³»ï¼ˆå‚è€ƒï¼‰
# ============================================
# GPUæ˜¾å­˜    | æ¨èworkers | è¯´æ˜
# ----------|------------|------------------
# 8GB       | 2          | æ¯ä¸ªæ¨¡å‹çº¦1.5GB
# 16GB      | 3-4        | ç•™å‡ºæ¨ç†ä¸´æ—¶æ˜¾å­˜
# 24GB      | 4-6        | å½“å‰æ¨èé…ç½®
# 32GB      | 6-8        | å¯é€‚å½“å¢åŠ 
# 40GB+     | 8-12       | æ ¹æ®å®é™…éœ€æ±‚
#
# è®¡ç®—å…¬å¼ï¼š
# workers = (GPUæ˜¾å­˜GB - ç³»ç»Ÿé¢„ç•™2GB) / æ¯ä¸ªæ¨¡å‹å ç”¨GB
# æ¯ä¸ªæ¨¡å‹å ç”¨ â‰ˆ 1.4-2.0 GBï¼ˆSAM2.1 Large + GroundingDINOï¼‰
# ============================================

# å·¥ä½œè¿›ç¨‹æ•°ï¼ˆæ ¹æ®ä½ çš„GPUæ˜¾å­˜è°ƒæ•´ï¼‰
workers = 4

# æ¯ä¸ªè¿›ç¨‹çº¿ç¨‹æ•°ï¼ˆCPUå¯†é›†å‹è®¾ä¸º1-2ï¼‰
threads = 2

# è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆæ¨¡å‹æ¨ç†å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼‰
timeout = 300

# CUDAä¸fork()ä¸å…¼å®¹ï¼Œä¸èƒ½ä½¿ç”¨preload_app
# æ¯ä¸ªworkerè¿›ç¨‹éœ€è¦ç‹¬ç«‹åŠ è½½æ¨¡å‹
# æ³¨æ„ï¼šè¿™ä¼šå¯¼è‡´æ¯ä¸ªè¿›ç¨‹éƒ½å ç”¨GPUå†…å­˜ï¼Œæ€»å†…å­˜ = æ¨¡å‹å¤§å° Ã— workeræ•°é‡
preload_app = False

# ç»‘å®šåœ°å€å’Œç«¯å£
bind = "0.0.0.0:6155"

# å®ˆæŠ¤è¿›ç¨‹æ¨¡å¼ï¼ˆåå°è¿è¡Œï¼‰
daemon = True

# è¿›ç¨‹åç§°
proc_name = "grounded-sam2-server"

# æ—¥å¿—é…ç½®
loglevel = "info"
accesslog = "logs/access.log"
errorlog = "logs/error.log"
access_log_format = '%(h)s %(l)s %(u)s %(t)s "%(r)s" %(s)s %(b)s "%(f)s" "%(a)s" %(D)s'

# é˜²æ­¢å†…å­˜æ³„æ¼ï¼šæ¯ä¸ªè¿›ç¨‹å¤„ç†1000ä¸ªè¯·æ±‚åè‡ªåŠ¨é‡å¯
max_requests = 1000
max_requests_jitter = 50

# ä¼˜é›…è¶…æ—¶è®¾ç½®
graceful_timeout = 60

# Workerå¯åŠ¨åå›è°ƒï¼šåœ¨æ¯ä¸ªworkerè¿›ç¨‹ä¸­åŠ è½½æ¨¡å‹
def on_starting(server):
    """ä¸»è¿›ç¨‹å¯åŠ¨æ—¶è°ƒç”¨"""
    import logging
    logger = logging.getLogger(__name__)
    logger.info("ğŸš€ Gunicornä¸»è¿›ç¨‹å¯åŠ¨")

def post_fork(server, worker):
    """æ¯ä¸ªworkerè¿›ç¨‹forkåè°ƒç”¨ - åœ¨è¿™é‡ŒåŠ è½½æ¨¡å‹"""
    import logging
    import os
    logger = logging.getLogger(__name__)
    logger.info(f"ğŸ”„ Workerè¿›ç¨‹ {os.getpid()} å¯åŠ¨ï¼Œæ­£åœ¨åŠ è½½æ¨¡å‹...")
    
    # åœ¨æ¯ä¸ªworkerè¿›ç¨‹ä¸­åŠ è½½æ¨¡å‹
    from model_manager import model_manager
    try:
        model_manager.load_models()
        logger.info(f"âœ… Workerè¿›ç¨‹ {os.getpid()} æ¨¡å‹åŠ è½½å®Œæˆ")
    except Exception as e:
        logger.error(f"âŒ Workerè¿›ç¨‹ {os.getpid()} æ¨¡å‹åŠ è½½å¤±è´¥: {e}")
        raise


